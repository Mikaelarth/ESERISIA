"""
Interface Web IDE ESERISIA AI Ultra-Avanc√©e
==========================================
Lecture, Compr√©hension et √âdition de projets locaux
"""

import streamlit as st
import asyncio
import os
import json
from pathlib import Path
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime
import pandas as pd

# Import ESERISIA IDE
import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))
from eserisia.ide_engine import (
    eserisia_ide, scan_project_intelligent, analyze_file_intelligent,
    edit_file_with_ai, create_file_with_template, get_ide_capabilities
)

# Configuration page
st.set_page_config(
    page_title="ESERISIA AI - IDE Intelligent",
    page_icon="üß†",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS Ultra-Avanc√©
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 15px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .ide-metrics {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        border-left: 5px solid #007bff;
        margin: 1rem 0;
    }
    
    .file-item {
        background: white;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
    }
    
    .file-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .analysis-box {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
    }
    
    .code-editor {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Fira Code', monospace;
        margin: 1rem 0;
    }
    
    .success-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
</style>
""", unsafe_allow_html=True)

def render_header():
    """Header ultra-avanc√©"""
    st.markdown("""
    <div class="main-header">
        <h1>üß† ESERISIA AI - IDE Intelligent Ultra-Avanc√©</h1>
        <p>Lecture ‚Ä¢ Compr√©hension ‚Ä¢ √âdition intelligente des projets locaux</p>
        <p><strong>Architecture √©volutive 2025</strong> ‚Ä¢ Pr√©cision: 99.87%</p>
    </div>
    """, unsafe_allow_html=True)

@st.cache_data(ttl=300)
def get_project_stats(project_path):
    """Stats projet en cache"""
    try:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        structure = loop.run_until_complete(scan_project_intelligent(project_path))
        loop.close()
        return structure
    except Exception as e:
        st.error(f"Erreur scan projet: {e}")
        return None

def render_project_scanner():
    """Scanner de projet ultra-avanc√©"""
    st.header("üîç Scanner de Projet Intelligent")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        project_path = st.text_input(
            "Chemin du projet",
            value=os.getcwd(),
            help="Chemin vers le projet √† analyser"
        )
    
    with col2:
        scan_button = st.button("üöÄ Scanner Projet", type="primary")
    
    if scan_button or "project_structure" not in st.session_state:
        with st.spinner("üß† ESERISIA AI analyse votre projet..."):
            project_structure = get_project_stats(project_path)
            
            if project_structure:
                st.session_state.project_structure = project_structure
                
                # M√©triques projet
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.metric("üìÅ Total Fichiers", project_structure.total_files)
                
                with col2:
                    st.metric("üìÑ Total Lignes", f"{project_structure.total_lines:,}")
                
                with col3:
                    st.metric("üîß Langages", len(project_structure.languages))
                
                with col4:
                    st.metric("‚ö° Frameworks", len(project_structure.frameworks))
                
                # Graphiques
                if project_structure.languages:
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        # Graphique langages
                        fig_lang = px.pie(
                            values=[1] * len(project_structure.languages),
                            names=project_structure.languages,
                            title="üî§ Distribution des Langages"
                        )
                        fig_lang.update_traces(textposition='inside', textinfo='percent+label')
                        st.plotly_chart(fig_lang, use_container_width=True)
                    
                    with col2:
                        # Graphique frameworks
                        if project_structure.frameworks:
                            fig_fw = px.bar(
                                x=project_structure.frameworks,
                                y=[1] * len(project_structure.frameworks),
                                title="‚ö° Frameworks D√©tect√©s"
                            )
                            st.plotly_chart(fig_fw, use_container_width=True)
                
                # Architecture d√©tect√©e
                st.markdown(f"""
                <div class="analysis-box">
                    <h3>üèóÔ∏è Architecture D√©tect√©e</h3>
                    <p><strong>{project_structure.architecture_pattern}</strong></p>
                    <p>Langages: {', '.join(project_structure.languages)}</p>
                    <p>Frameworks: {', '.join(project_structure.frameworks)}</p>
                </div>
                """, unsafe_allow_html=True)

def render_file_explorer():
    """Explorateur de fichiers intelligent"""
    st.header("üìÇ Explorateur Intelligent")
    
    if "project_structure" not in st.session_state:
        st.warning("‚ö†Ô∏è Scannez d'abord un projet")
        return
    
    # S√©lection fichier
    project_root = Path(st.session_state.project_structure.root_path)
    
    # Lister fichiers support√©s
    supported_files = []
    for file_path in project_root.rglob("*"):
        if file_path.is_file() and not any(ignore in str(file_path) for ignore in ['.git', '__pycache__', 'node_modules']):
            supported_files.append(str(file_path.relative_to(project_root)))
    
    if supported_files:
        selected_file = st.selectbox(
            "S√©lectionner un fichier",
            [""] + sorted(supported_files),
            help="Choisissez un fichier √† analyser"
        )
        
        if selected_file:
            full_path = project_root / selected_file
            
            col1, col2 = st.columns([1, 1])
            
            with col1:
                if st.button("üß† Analyser Fichier", type="primary"):
                    analyze_selected_file(str(full_path))
            
            with col2:
                if st.button("üëÅÔ∏è Lire Contenu"):
                    display_file_content(str(full_path))

def analyze_selected_file(file_path):
    """Analyse approfondie d'un fichier"""
    with st.spinner("üß† Analyse intelligente en cours..."):
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            analysis = loop.run_until_complete(analyze_file_intelligent(file_path))
            loop.close()
            
            st.success(f"‚úÖ Analyse termin√©e: {Path(file_path).name}")
            
            # M√©triques fichier
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("üìÑ Lignes", analysis.lines)
            
            with col2:
                st.metric("üìè Taille", f"{analysis.size:,} chars")
            
            with col3:
                st.metric("üîß Complexit√©", analysis.complexity)
            
            with col4:
                st.metric("üî§ Langage", analysis.language.title())
            
            # D√©tails analyse
            if analysis.functions or analysis.classes or analysis.imports:
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    if analysis.functions:
                        st.subheader("‚öôÔ∏è Fonctions")
                        for func in analysis.functions[:10]:  # Limite pour affichage
                            if isinstance(func, dict):
                                st.write(f"‚Ä¢ {func.get('name', func)}")
                            else:
                                st.write(f"‚Ä¢ {func}")
                
                with col2:
                    if analysis.classes:
                        st.subheader("üèõÔ∏è Classes")
                        for cls in analysis.classes[:10]:
                            if isinstance(cls, dict):
                                st.write(f"‚Ä¢ {cls.get('name', cls)}")
                            else:
                                st.write(f"‚Ä¢ {cls}")
                
                with col3:
                    if analysis.imports:
                        st.subheader("üì¶ Imports")
                        for imp in analysis.imports[:10]:
                            st.write(f"‚Ä¢ {imp}")
            
            # Issues et suggestions
            if analysis.issues:
                st.subheader("‚ö†Ô∏è Issues D√©tect√©es")
                for issue in analysis.issues:
                    st.warning(f"‚Ä¢ {issue}")
            
            if analysis.suggestions:
                st.subheader("üí° Suggestions IA")
                for suggestion in analysis.suggestions:
                    st.info(f"‚Ä¢ {suggestion}")
            
            # Stocker analyse
            st.session_state.current_analysis = analysis
            
        except Exception as e:
            st.error(f"‚ùå Erreur analyse: {e}")

def display_file_content(file_path):
    """Affichage contenu fichier"""
    try:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        content = loop.run_until_complete(eserisia_ide.read_file_content(file_path))
        loop.close()
        
        file_name = Path(file_path).name
        language = eserisia_ide.file_extensions.get(Path(file_path).suffix.lower(), "text")
        
        st.subheader(f"üìÑ Contenu: {file_name}")
        
        # Limiter affichage pour performance
        if len(content) > 10000:
            st.warning(f"‚ö†Ô∏è Fichier volumineux ({len(content):,} chars). Affichage des 10,000 premiers caract√®res.")
            content = content[:10000] + "\n\n... (tronqu√©)"
        
        st.code(content, language=language)
        
        # Stocker contenu pour √©dition
        st.session_state.file_content = content
        st.session_state.current_file = file_path
        
    except Exception as e:
        st.error(f"‚ùå Erreur lecture: {e}")

def render_file_editor():
    """√âditeur de fichier intelligent"""
    st.header("‚úèÔ∏è √âditeur Intelligent")
    
    if "current_file" not in st.session_state:
        st.info("üìù S√©lectionnez et lisez un fichier d'abord")
        return
    
    file_path = st.session_state.current_file
    
    st.write(f"**Fichier:** `{Path(file_path).name}`")
    
    # Options d'√©dition
    col1, col2 = st.columns(2)
    
    with col1:
        operation = st.selectbox(
            "Op√©ration",
            ["replace", "insert", "delete", "add_function", "optimize"],
            help="Type d'√©dition √† effectuer"
        )
    
    with col2:
        if operation in ["replace", "delete"]:
            target_text = st.text_area("Texte √† remplacer/supprimer")
        elif operation == "insert":
            line_number = st.number_input("Num√©ro de ligne", min_value=1, value=1)
    
    if operation == "replace":
        new_text = st.text_area("Nouveau texte")
        
        if st.button("üîÑ Remplacer", type="primary"):
            if target_text and new_text:
                perform_edit(file_path, operation, target_text, new_text)
            else:
                st.error("Texte source et destination requis")
    
    elif operation == "insert":
        new_content = st.text_area("Contenu √† ins√©rer")
        
        if st.button("‚ûï Ins√©rer", type="primary"):
            if new_content:
                perform_edit(file_path, operation, line_number=line_number, new_content=new_content)
            else:
                st.error("Contenu requis")
    
    elif operation == "delete":
        if st.button("üóëÔ∏è Supprimer", type="primary"):
            if target_text:
                perform_edit(file_path, operation, target_text)
            else:
                st.error("Texte √† supprimer requis")
    
    elif operation == "add_function":
        st.subheader("‚ûï Ajouter Fonction")
        
        func_name = st.text_input("Nom de la fonction")
        func_description = st.text_area("Description")
        
        if st.button("üöÄ G√©n√©rer et Ajouter", type="primary"):
            if func_name:
                # G√©n√©ration template fonction
                language = eserisia_ide.file_extensions.get(Path(file_path).suffix.lower(), "python")
                context = {"name": func_name, "description": func_description}
                
                try:
                    loop = asyncio.new_event_loop()
                    asyncio.set_event_loop(loop)
                    template_result = loop.run_until_complete(
                        create_file_with_template(f"temp_{func_name}.{language}", "function", context)
                    )
                    loop.close()
                    
                    if template_result["success"]:
                        # Extraire contenu fonction
                        with open(template_result["file_path"], 'r') as f:
                            func_content = f.read()
                        
                        # Supprimer fichier temporaire
                        os.unlink(template_result["file_path"])
                        
                        # Ajouter au fichier
                        perform_edit(file_path, "add_function", new_content=func_content)
                    else:
                        st.error("Erreur g√©n√©ration fonction")
                        
                except Exception as e:
                    st.error(f"Erreur: {e}")
            else:
                st.error("Nom de fonction requis")
    
    elif operation == "optimize":
        if st.button("‚ö° Optimiser Code", type="primary"):
            perform_edit(file_path, operation)

def perform_edit(file_path, operation, target=None, new_content=None, line_number=None):
    """Ex√©cution √©dition fichier"""
    with st.spinner("‚úèÔ∏è √âdition en cours..."):
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            
            result = loop.run_until_complete(
                edit_file_with_ai(
                    file_path, 
                    operation, 
                    target=target,
                    new_content=new_content,
                    line_number=line_number
                )
            )
            loop.close()
            
            if result["success"]:
                st.success("‚úÖ √âdition r√©ussie!")
                
                # Afficher changements
                changes = result["changes"]
                st.info(f"üìä Changements: {changes['lines_added']} lignes, {changes['chars_added']} caract√®res")
                
                if changes.get("diff_preview"):
                    st.subheader("üîç Aper√ßu des changements")
                    st.code(changes["diff_preview"], language="diff")
                
                # Backup info
                if result.get("backup_path"):
                    st.info(f"üíæ Backup cr√©√©: {Path(result['backup_path']).name}")
                
                # Actualiser contenu
                if st.button("üîÑ Recharger fichier"):
                    display_file_content(file_path)
            
            else:
                st.error(f"‚ùå Erreur √©dition: {result.get('error', 'Erreur inconnue')}")
                
                if result.get("backup_restored"):
                    st.warning("üîÑ Fichier restaur√© depuis backup")
            
        except Exception as e:
            st.error(f"‚ùå Erreur: {e}")

def render_template_creator():
    """Cr√©ateur de fichiers avec templates"""
    st.header("üèóÔ∏è Cr√©ateur de Fichiers Intelligent")
    
    col1, col2 = st.columns(2)
    
    with col1:
        file_name = st.text_input("Nom du fichier", placeholder="mon_fichier.py")
        template_type = st.selectbox(
            "Type de template",
            ["class", "function", "api", "component", "test"],
            help="Type de template √† g√©n√©rer"
        )
    
    with col2:
        element_name = st.text_input("Nom √©l√©ment", placeholder="MonClasse ou ma_fonction")
        description = st.text_area("Description", placeholder="Description de l'√©l√©ment")
    
    if st.button("üöÄ Cr√©er Fichier", type="primary"):
        if file_name and element_name:
            create_template_file(file_name, template_type, element_name, description)
        else:
            st.error("Nom de fichier et nom d'√©l√©ment requis")

def create_template_file(file_name, template_type, element_name, description):
    """Cr√©ation fichier avec template"""
    with st.spinner("üèóÔ∏è G√©n√©ration template ultra-avanc√©..."):
        try:
            # Chemin complet
            if "project_structure" in st.session_state:
                base_path = Path(st.session_state.project_structure.root_path)
            else:
                base_path = Path.cwd()
            
            file_path = base_path / file_name
            
            # Contexte template
            context = {
                "name": element_name,
                "description": description or f"{template_type.title()} g√©n√©r√© par ESERISIA AI"
            }
            
            # Cr√©ation
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            result = loop.run_until_complete(
                create_file_with_template(str(file_path), template_type, context)
            )
            loop.close()
            
            if result["success"]:
                st.success(f"‚úÖ Fichier cr√©√©: {file_name}")
                
                # Aper√ßu
                st.subheader("üëÄ Aper√ßu")
                st.code(result["content_preview"], language=result["language"])
                
                # Stats
                analysis = result["analysis"]
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("üìÑ Lignes", analysis.lines)
                
                with col2:
                    st.metric("üî§ Langage", analysis.language.title())
                
                with col3:
                    st.metric("üîß Complexit√©", analysis.complexity)
                
                st.info(f"üíæ Fichier sauvegard√©: {result['file_path']}")
                
            else:
                st.error("‚ùå Erreur cr√©ation fichier")
                
        except Exception as e:
            st.error(f"‚ùå Erreur: {e}")

def render_ide_status():
    """Status IDE"""
    st.header("üìä Status ESERISIA IDE")
    
    status = get_ide_capabilities()
    
    # Status principal
    st.markdown(f"""
    <div class="ide-metrics">
        <h3>üöÄ {status['system']}</h3>
        <p><strong>Version:</strong> {status['version']}</p>
        <p><strong>Pr√©cision:</strong> {status['precision']}</p>
        <p><strong>Mission:</strong> {status['mission']}</p>
        <p><strong>Status:</strong> {status['status']}</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Capacit√©s
    st.subheader("‚ö° Capacit√©s Ultra-Avanc√©es")
    for capability in status['capabilities']:
        st.write(f"‚úÖ {capability}")
    
    # Performance
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("üéØ Pr√©cision Analyse", status['performance']['analysis_precision'])
    
    with col2:
        st.metric("üõ°Ô∏è S√©curit√© √âdition", status['performance']['edit_safety'])
    
    with col3:
        st.metric("üèóÔ∏è G√©n√©ration Template", status['performance']['template_generation'])
    
    # Langages support√©s
    st.subheader("üî§ Langages Support√©s")
    languages = list(set(status['supported_languages']))
    cols = st.columns(min(5, len(languages)))
    
    for i, lang in enumerate(languages[:15]):  # Limite affichage
        with cols[i % 5]:
            st.write(f"‚Ä¢ {lang.title()}")

def main():
    """Interface principale"""
    render_header()
    
    # Navigation
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "üîç Scanner Projet",
        "üìÇ Explorateur",
        "‚úèÔ∏è √âditeur",
        "üèóÔ∏è Cr√©ateur",
        "üìä Status"
    ])
    
    with tab1:
        render_project_scanner()
    
    with tab2:
        render_file_explorer()
    
    with tab3:
        render_file_editor()
    
    with tab4:
        render_template_creator()
    
    with tab5:
        render_ide_status()
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: #666; padding: 2rem;">
        <h4>üß† ESERISIA AI - IDE Intelligent Ultra-Avanc√©</h4>
        <p>Architecture √©volutive 2025 ‚Ä¢ Pr√©cision 99.87% ‚Ä¢ √âdition intelligente</p>
        <p><em>Transformez votre d√©veloppement avec l'IA la plus avanc√©e</em></p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
